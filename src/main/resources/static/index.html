<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>StratusVault — Secure Document Locker</title>
    <link rel="icon" href="data:,"/>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { color-scheme: light; }
        body { font-family: 'Inter', sans-serif; }
        .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.75); }
        .elev { box-shadow: 0 10px 30px rgba(2, 6, 23, 0.08); }
        .modal-overlay { transition: opacity .2s ease; }
        .modal-card { transform: translateY(8px); opacity: 0; transition: all .2s ease; }
        .modal-open .modal-card { transform: translateY(0); opacity: 1; }
        .drop-active { border-color: #3b82f6; background-color: #eff6ff; }
        .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; border-radius:.75rem; font-weight:600; }
        .btn-sm { padding:.5rem .75rem; font-size:.8rem; }
        .btn-md { padding:.625rem .875rem; font-size:.9rem; }
        .btn-blue { background:#2563eb; color:#fff; }
        .btn-blue:hover { background:#1d4ed8; }
        .btn-white { background:#fff; color:#0f172a; border:1px solid rgba(2,6,23,.1); }
        .btn-white:hover { background:#f8fafc; }
        .btn-red { background:#dc2626; color:#fff; }
        .btn-red:hover { background:#b91c1c; }
        .skeleton { animation: pulse 1.2s ease-in-out infinite; background: linear-gradient(90deg,#f1f5f9 25%,#e2e8f0 37%,#f1f5f9 63%); background-size:400% 100%; }
        @keyframes pulse { 0%{background-position:100% 50%} 100%{background-position:0 50%} }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-50">
<!-- Topbar -->
<header class="sticky top-0 z-20 bg-white/70 glass border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-blue-600 text-white grid place-items-center elev">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.75 7.5 12 3l8.25 4.5M3.75 7.5 12 12m0 0 8.25-4.5M12 12v9"/>
                </svg>
            </div>
            <div class="leading-tight">
                <div class="font-semibold text-slate-900">StratusVault</div>
                <div class="text-xs text-slate-500">Secure Document Locker</div>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <span id="header-user" class="hidden text-sm text-slate-600"></span>
            <button id="login-button" class="btn btn-md btn-blue">Sign In with Google</button>
            <button id="logout-button" class="hidden btn btn-md btn-white">Log Out</button>
        </div>
    </div>
</header>

<!-- Logged out hero -->
<main id="logged-out-view" class="max-w-7xl mx-auto px-4">
    <section class="mt-16 grid md:grid-cols-2 gap-8 items-center">
        <div>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Your files, organized & secure.</h1>
            <p class="mt-3 text-slate-600">Upload, share, and download with confidence. Sign in to get started.</p>
            <div class="mt-6 flex gap-3">
                <button id="login-button-hero" class="btn btn-md btn-blue">Sign In with Google</button>
                <a class="btn btn-md btn-white" href="#">Learn more</a>
            </div>
        </div>
        <div class="glass elev rounded-2xl p-6">
            <div class="h-32 rounded-xl bg-gradient-to-tr from-blue-100 to-indigo-100"></div>
            <div class="mt-4 h-3 rounded skeleton"></div>
            <div class="mt-2 h-3 rounded skeleton w-5/6"></div>
            <div class="mt-2 h-3 rounded skeleton w-4/6"></div>
        </div>
    </section>
</main>

<!-- Logged in dashboard -->
<main id="logged-in-view" class="hidden max-w-7xl mx-auto px-4">
    <div class="mt-8 flex items-center justify-between">
        <div>
            <h2 class="text-xl font-semibold text-slate-900">Dashboard</h2>
            <p id="user-welcome" class="text-sm text-slate-500">Welcome!</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="refresh-button" class="btn btn-md btn-white">Refresh</button>
            <button id="open-upload-modal" class="btn btn-md btn-blue">Upload</button>
        </div>
    </div>

    <div id="status-message" class="mt-4 hidden"></div>

    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <section class="lg:col-span-2 space-y-6">
            <div class="glass elev rounded-2xl p-6">
                <h3 class="text-base font-semibold text-slate-900">My Files</h3>
                <div id="my-files-container" class="mt-4"></div>
            </div>

            <div class="glass elev rounded-2xl p-6">
                <h3 class="text-base font-semibold text-slate-900">Files Shared With Me</h3>
                <div id="shared-files-container" class="mt-4"></div>
            </div>
        </section>

        <aside class="lg:col-span-1">
            <div class="glass elev rounded-2xl p-6">
                <h3 class="text-base font-semibold text-slate-900">Quick Actions</h3>
                <p class="mt-2 text-sm text-slate-600">Upload new files, share with others, or manage your documents.</p>
                <button id="open-upload-modal-2" class="mt-4 btn btn-md btn-blue w-full">Upload a File</button>
            </div>
        </aside>
    </div>
</main>

<!-- Upload Modal -->
<div id="upload-modal" class="hidden fixed inset-0 z-30 modal-overlay bg-black/40"></div>
<div id="upload-modal-card" class="hidden fixed inset-0 z-40 grid place-items-center modal-open">
    <div class="modal-card glass elev w-full max-w-lg rounded-2xl">
        <div class="p-6">
            <div class="flex items-start justify-between">
                <div>
                    <h3 class="text-base font-semibold text-slate-900">Upload a file</h3>
                    <p class="text-sm text-slate-500">Select a file or drag & drop.</p>
                </div>
                <button id="close-upload-x" class="btn btn-sm btn-white">✕</button>
            </div>

            <div id="drop-zone" class="mt-4 border-2 border-dashed border-slate-300 rounded-xl p-6 text-center">
                <input id="modal-file-input" type="file" class="sr-only"/>
                <p id="selected-file-name" class="text-sm text-slate-600">No file selected</p>
                <div class="mt-4 flex items-center justify-center gap-2">
                    <button id="choose-file-button" class="btn btn-md btn-white">Choose file</button>
                </div>
            </div>

            <div id="upload-progress" class="mt-4 hidden">
                <div class="w-full bg-slate-200 rounded-full h-2.5">
                    <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width:0%"></div>
                </div>
                <p id="upload-progress-label" class="mt-2 text-xs text-slate-500">0%</p>
            </div>
        </div>
        <div class="bg-slate-50/70 rounded-b-2xl px-6 py-3 flex items-center justify-end gap-2">
            <button id="cancel-upload-button" class="btn btn-md btn-white">Cancel</button>
            <button id="confirm-upload-button" class="btn btn-md btn-blue" disabled>Upload</button>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="hidden fixed inset-0 z-30 modal-overlay bg-black/40"></div>
<div id="share-modal-card" class="hidden fixed inset-0 z-40 grid place-items-center modal-open">
    <div class="modal-card glass elev w-full max-w-lg rounded-2xl">
        <div class="p-6">
            <div class="flex items-start justify-between">
                <div>
                    <h3 class="text-base font-semibold text-slate-900">Share Document</h3>
                    <p id="share-modal-filename" class="text-sm text-slate-500"></p>
                </div>
                <button id="close-share-x" class="btn btn-sm btn-white">✕</button>
            </div>
            <label class="mt-4 block text-sm font-medium text-slate-900">User's Email Address</label>
            <input id="share-email-input" type="email" required class="mt-2 block w-full rounded-md border-0 py-2 px-3 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-blue-600" placeholder="you@example.com"/>
        </div>
        <div class="bg-slate-50/70 rounded-b-2xl px-6 py-3 flex items-center justify-end gap-2">
            <button id="cancel-share-button" class="btn btn-md btn-white">Cancel</button>
            <button id="confirm-share-button" class="btn btn-md btn-blue">Share</button>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div id="delete-modal" class="hidden fixed inset-0 z-30 modal-overlay bg-black/40"></div>
<div id="delete-modal-card" class="hidden fixed inset-0 z-40 grid place-items-center modal-open">
    <div class="modal-card glass elev w-full max-w-lg rounded-2xl">
        <div class="p-6">
            <div class="flex items-start justify-between">
                <div>
                    <h3 class="text-base font-semibold text-slate-900">Delete Document</h3>
                    <p id="delete-modal-text" class="text-sm text-slate-500"></p>
                </div>
                <button id="close-delete-x" class="btn btn-sm btn-white">✕</button>
            </div>
        </div>
        <div class="bg-slate-50/70 rounded-b-2xl px-6 py-3 flex items-center justify-end gap-2">
            <button id="cancel-delete-button" class="btn btn-md btn-white">Cancel</button>
            <button id="confirm-delete-button" class="btn btn-md btn-red">Delete</button>
        </div>
    </div>
</div>

<script>
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyDdlsW4LniE3cRSBdiAQ7FlfrJPn6g-bns",
        authDomain: "stratus-vault.firebaseapp.com",
        projectId: "stratus-vault",
        storageBucket: "stratus-vault.firebasestorage.app",
        messagingSenderId: "887984050545",
        appId: "1:887984050545:web:0ef08df970581f312ba6d0",
        measurementId: "G-FM00RLGMMC"
    };
    try { if (typeof firebaseConfig !== 'undefined' && !firebase.apps.length) { firebase.initializeApp(firebaseConfig); } }
    catch (e) { console.error('Firebase init failed:', e); }
    var auth = (firebase.apps && firebase.apps.length) ? firebase.auth() : null;

    /* ---------- DOM ---------- */
    var loggedOutView = document.getElementById('logged-out-view');
    var loggedInView  = document.getElementById('logged-in-view');
    var loginButton   = document.getElementById('login-button');
    var loginButtonHero = document.getElementById('login-button-hero');
    var logoutButton  = document.getElementById('logout-button');
    var headerUser    = document.getElementById('header-user');
    var userWelcome   = document.getElementById('user-welcome');

    var refreshButton = document.getElementById('refresh-button');
    var statusMessage = document.getElementById('status-message');

    var myFilesContainer = document.getElementById('my-files-container');
    var sharedFilesContainer = document.getElementById('shared-files-container');

    // Upload modal
    var uploadModal = document.getElementById('upload-modal');
    var uploadCard  = document.getElementById('upload-modal-card');
    var closeUploadX = document.getElementById('close-upload-x');
    var openUpload1 = document.getElementById('open-upload-modal');
    var openUpload2 = document.getElementById('open-upload-modal-2');
    var cancelUploadButton = document.getElementById('cancel-upload-button');
    var confirmUploadButton = document.getElementById('confirm-upload-button');
    var modalFileInput = document.getElementById('modal-file-input');
    var chooseFileButton = document.getElementById('choose-file-button');
    var selectedFileName = document.getElementById('selected-file-name');
    var dropZone = document.getElementById('drop-zone');
    var uploadProgress = document.getElementById('upload-progress');
    var uploadProgressBar = document.getElementById('upload-progress-bar');
    var uploadProgressLabel = document.getElementById('upload-progress-label');

    // Share modal
    var shareModal = document.getElementById('share-modal');
    var shareCard  = document.getElementById('share-modal-card');
    var cancelShareButton = document.getElementById('cancel-share-button');
    var confirmShareButton = document.getElementById('confirm-share-button');
    var shareEmailInput = document.getElementById('share-email-input');
    var shareModalFilename = document.getElementById('share-modal-filename');
    var closeShareX = document.getElementById('close-share-x');

    // Delete modal
    var deleteModal = document.getElementById('delete-modal');
    var deleteCard  = document.getElementById('delete-modal-card');
    var cancelDeleteButton = document.getElementById('cancel-delete-button');
    var confirmDeleteButton = document.getElementById('confirm-delete-button');
    var deleteModalText = document.getElementById('delete-modal-text');
    var closeDeleteX = document.getElementById('close-delete-x');

    // State
    var currentFile = null;
    var currentDocToShare = null;
    var currentDocToDelete = null;

    /* ---------- Helpers (handle DTO or entity shapes) ---------- */
    function getOwnerUid(doc){
        return (doc.owner && doc.owner.firebaseUid) ||
            doc.ownerFirebaseUid || doc.owner_uid || doc.ownerUid || null;
    }
    function getOwnerEmail(doc){
        return (doc.owner && (doc.owner.email || doc.owner.username || doc.owner.name)) ||
            doc.ownerEmail || doc.owner_email || doc.ownerName || doc.owner_name || '';
    }
    function getUploadTs(doc){
        return doc.uploadTimeStamp || doc.uploadTimestamp || doc.uploadedAt || doc.createdAt || null;
    }
    function getSize(doc){
        return (doc.originalSize!=null ? doc.originalSize :
            (doc.size!=null ? doc.size :
                (doc.fileSize!=null ? doc.fileSize : 0)));
    }
    function getName(doc){ return doc.fileName || doc.filename || doc.name || 'file'; }
    function getId(doc){ return (doc.id!=null ? doc.id : (doc.documentId!=null ? doc.documentId : doc.document_id)); }

    // KEY FIX: classify correctly even if owner is missing in the payload
    function isSharedWithMe(doc, currentUid){
        var ou = getOwnerUid(doc);
        if (ou) return ou !== currentUid;                 // confident classification
        if (doc.shared === true || doc.sharedWithMe === true) return true; // explicit flags
        return false;                                     // default to "My Files" if unknown
    }

    function fmtBytes(bytes){ if(!+bytes)return'0 Bytes'; var u=['Bytes','KB','MB','GB','TB']; var i=Math.floor(Math.log(bytes)/Math.log(1024)); var v=(bytes/Math.pow(1024,i)).toFixed(2); return parseFloat(v)+' '+u[i]; }
    function el(tag, cls, txt){ var n=document.createElement(tag); if(cls) n.className=cls; if(txt!=null) n.textContent=txt; return n; }
    function clr(node){ while(node.firstChild) node.removeChild(node.firstChild); }
    function toast(msg, ok){ statusMessage.className='mt-4 rounded-xl px-4 py-3 elev text-sm '+(ok?'bg-green-50 text-green-800':'bg-red-50 text-red-800'); statusMessage.textContent=msg; statusMessage.style.display='block'; setTimeout(function(){ statusMessage.style.display='none'; }, 2600); }

    /* ---------- Auth ---------- */
    if (auth) {
        function onSignedIn(user){
            loggedOutView.classList.add('hidden');
            loggedInView.classList.remove('hidden');
            headerUser.classList.remove('hidden');
            headerUser.textContent = user.displayName || user.email || 'user';
            document.getElementById('logout-button').classList.remove('hidden');
            document.getElementById('login-button').classList.add('hidden');
            userWelcome.textContent = 'Welcome, ' + (user.displayName || user.email || 'user');
            fetchDocuments();
        }
        function onSignedOut(){
            loggedInView.classList.add('hidden');
            loggedOutView.classList.remove('hidden');
            headerUser.classList.add('hidden');
            headerUser.textContent = '';
            document.getElementById('logout-button').classList.add('hidden');
            document.getElementById('login-button').classList.remove('hidden');
            clr(myFilesContainer); clr(sharedFilesContainer);
        }
        auth.onAuthStateChanged(function(user){ if(user) onSignedIn(user); else onSignedOut(); });

        function startLogin(){ var provider=new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(function(e){ console.error(e); toast('Login failed: '+e.message,false); }); }
        if (loginButton) loginButton.addEventListener('click', startLogin);
        if (loginButtonHero) loginButtonHero.addEventListener('click', startLogin);
        logoutButton.addEventListener('click', function(){ auth.signOut(); });
    }

    /* ---------- Fetch & render ---------- */
    function skeleton(container){
        clr(container);
        var wrap = el('div','space-y-2');
        for (var i=0;i<3;i++){ var s=el('div','h-10 rounded skeleton'); wrap.appendChild(s); }
        container.appendChild(wrap);
    }

    async function fetchDocuments(){
        var user = auth && auth.currentUser; if(!user) return;
        skeleton(myFilesContainer); skeleton(sharedFilesContainer);

        var token = await user.getIdToken();
        try{
            var r = await fetch('/api/documents',{ headers:{ 'Authorization':'Bearer '+token }});
            if(!r.ok){ clr(myFilesContainer); clr(sharedFilesContainer); toast('Could not load your documents.', false); return; }
            var docs = await r.json();
            renderLists(docs);
        }catch(e){ console.error(e); clr(myFilesContainer); clr(sharedFilesContainer); toast('Could not load your documents.', false); }
    }

    function renderLists(docs){
        var me = auth && auth.currentUser;
        if(!me || !Array.isArray(docs)) return;

        var mine = [], shared = [];
        for (var i=0;i<docs.length;i++){
            var d = docs[i];
            if (isSharedWithMe(d, me.uid)) shared.push(d); else mine.push(d);
        }

        renderTable(myFilesContainer, mine, true);
        renderTable(sharedFilesContainer, shared, false);
    }

    function renderTable(container, list, isOwner){
        clr(container);
        if(!list || list.length===0){
            var empty = el('div','text-center py-12');
            empty.appendChild(el('div','mx-auto h-12 w-12 rounded-full bg-slate-100 grid place-items-center'));
            empty.lastChild.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.33-2.33 4.5 4.5 0 01-1.41 8.775"/></svg>';
            empty.appendChild(el('h4','mt-4 text-sm font-medium text-slate-900', isOwner?'No documents yet':'No shared documents'));
            empty.appendChild(el('p','mt-1 text-sm text-slate-500', isOwner?'Upload a file to get started.':'Ask someone to share a file with you.'));
            container.appendChild(empty);
            return;
        }

        var table = el('div','overflow-hidden rounded-xl border border-slate-200');
        var head = el('div','grid grid-cols-12 bg-slate-50 border-b border-slate-200 px-4 py-3 text-xs font-semibold text-slate-600');
        head.appendChild(el('div','col-span-6','File'));
        head.appendChild(el('div','col-span-2','Size'));
        if(!isOwner) head.appendChild(el('div','col-span-2','Owner'));
        else head.appendChild(el('div','col-span-2','Uploaded'));
        head.appendChild(el('div','col-span-2 text-right','Actions'));
        table.appendChild(head);

        list.sort(function(a,b){
            var ta = new Date(getUploadTs(a)||0).getTime();
            var tb = new Date(getUploadTs(b)||0).getTime();
            return tb - ta;
        });

        for (var i=0;i<list.length;i++){
            var d = list[i];
            var row = el('div','grid grid-cols-12 items-center px-4 py-3 hover:bg-slate-50 transition-colors');

            var left = el('div','col-span-6 flex items-center gap-3');
            var icon = el('div','h-9 w-9 rounded-lg bg-blue-50 text-blue-600 grid place-items-center');
            icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7.5A2.25 2.25 0 015.25 5.25h7.5L18 10.5v6.75A2.25 2.25 0 0115.75 19.5H5.25A2.25 2.25 0 013 17.25V7.5z"/></svg>';
            var meta = el('div','min-w-0');
            meta.appendChild(el('div','truncate text-sm font-medium text-slate-900', getName(d)));
            meta.appendChild(el('div','text-xs text-slate-500', new Date(getUploadTs(d)||Date.now()).toLocaleString()));
            left.appendChild(icon); left.appendChild(meta);
            row.appendChild(left);

            row.appendChild(el('div','col-span-2 text-sm text-slate-600', fmtBytes(getSize(d))));

            if(!isOwner){
                var ownerLabel = getOwnerEmail(d);
                if (!ownerLabel) {
                    var ou = getOwnerUid(d);
                    ownerLabel = ou ? '(' + String(ou).slice(0,6) + '…)' : '—';
                }
                row.appendChild(el('div','col-span-2 text-sm text-slate-600', ownerLabel));
            } else {
                row.appendChild(el('div','col-span-2 text-sm text-slate-600', new Date(getUploadTs(d)||Date.now()).toLocaleDateString()));
            }

            var actions = el('div','col-span-2 flex items-center justify-end gap-2');
            var btnDl = el('button','btn btn-sm btn-white'); btnDl.textContent='Download'; btnDl.dataset.docId=getId(d);
            actions.appendChild(btnDl);
            if(isOwner){
                var btnSh = el('button','btn btn-sm btn-white'); btnSh.textContent='Share'; btnSh.dataset.docId=getId(d); btnSh.dataset.docName=getName(d);
                var btnDel = el('button','btn btn-sm btn-red'); btnDel.textContent='Delete'; btnDel.dataset.docId=getId(d); btnDel.dataset.docName=getName(d);
                actions.appendChild(btnSh); actions.appendChild(btnDel);
            }
            row.appendChild(actions);

            table.appendChild(row);
        }

        container.appendChild(table);
    }

    /* ---------- Download ---------- */
    async function downloadDocument(id){
        var user = auth && auth.currentUser; if(!user) return;
        var token = await user.getIdToken();
        var res = await fetch('/api/documents/'+id+'/download',{ headers:{ 'Authorization':'Bearer '+token }});
        if(!res.ok) throw new Error('Server error: '+res.statusText);
        var blob = await res.blob();
        var cd = res.headers.get('content-disposition'); var name='downloaded-file';
        if(cd){ var m=cd.match(/filename="?([^"]+)"?/); if(m&&m[1]) name=m[1]; }
        var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    }

    /* ---------- Upload (XHR with progress) ---------- */
    function openUpload(){ uploadModal.classList.remove('hidden'); uploadCard.classList.remove('hidden'); setSelectedFile(null); uploadProgress.classList.add('hidden'); }
    function closeUpload(){ uploadModal.classList.add('hidden'); uploadCard.classList.add('hidden'); }
    function setSelectedFile(f){ currentFile=f; selectedFileName.textContent = f?f.name:'No file selected'; confirmUploadButton.disabled = !f; }

    chooseFileButton.addEventListener('click', function(){ modalFileInput.click(); });
    modalFileInput.addEventListener('change', function(e){ setSelectedFile(e.target.files && e.target.files[0] || null); });
    ['dragenter','dragover'].forEach(function(evt){ dropZone.addEventListener(evt,function(e){ e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drop-active'); }); });
    ['dragleave','drop'].forEach(function(evt){ dropZone.addEventListener(evt,function(e){ e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drop-active'); }); });
    dropZone.addEventListener('drop', function(e){ var f=e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]; setSelectedFile(f||null); });

    function uploadFile(file, token){
        uploadProgress.classList.remove('hidden');
        var formData=new FormData(); formData.append('file',file);
        var xhr=new XMLHttpRequest();
        xhr.open('POST','/api/documents/upload',true);
        xhr.setRequestHeader('Authorization','Bearer '+token);
        xhr.upload.onprogress=function(e){ if(e.lengthComputable){ var p=Math.round(e.loaded/e.total*100); uploadProgressBar.style.width=p+'%'; uploadProgressLabel.textContent=p+'%'; } };
        xhr.onloadstart=function(){ confirmUploadButton.disabled=true; confirmUploadButton.textContent='Uploading…'; };
        xhr.onload=function(){
            confirmUploadButton.disabled=false; confirmUploadButton.textContent='Upload';
            if(xhr.status===201){ closeUpload(); toast('Upload complete.', true); fetchDocuments(); }
            else { toast('Upload failed: '+(xhr.responseText||'Server error'), false); }
        };
        xhr.onerror=function(){ confirmUploadButton.disabled=false; confirmUploadButton.textContent='Upload'; toast('Network error during upload.', false); };
        xhr.send(formData);
    }

    /* ---------- Share ---------- */
    function openShare(name,id){ currentDocToShare={ id:id, name:name }; shareModalFilename.textContent='Sharing: '+name; shareModal.classList.remove('hidden'); shareCard.classList.remove('hidden'); }
    function closeShare(){ shareModal.classList.add('hidden'); shareCard.classList.add('hidden'); shareEmailInput.value=''; }

    /* ---------- Delete ---------- */
    function openDelete(name,id){ currentDocToDelete={ id:id, name:name }; deleteModalText.textContent='Are you sure you want to delete "'+name+'"? This action cannot be undone.'; deleteModal.classList.remove('hidden'); deleteCard.classList.remove('hidden'); }
    function closeDelete(){ deleteModal.classList.add('hidden'); deleteCard.classList.add('hidden'); }

    /* ---------- Global clicks ---------- */
    document.addEventListener('click', async function(e){
        var t=e.target;

        // Upload modal triggers
        if(t.id==='open-upload-modal'||t.id==='open-upload-modal-2'){ openUpload(); return; }
        if(t.id==='cancel-upload-button'||t.id==='close-upload-x'||t===uploadModal){ closeUpload(); return; }
        if(t.id==='confirm-upload-button'){ var user=auth&&auth.currentUser; if(!user||!currentFile){ toast('Select a file first.', false); return; } var tok=await user.getIdToken(); uploadFile(currentFile, tok); return; }

        // Share modal triggers
        if(t.id==='cancel-share-button'||t.id==='close-share-x'||t===shareModal){ closeShare(); return; }
        if(t.id==='confirm-share-button'){ var u=auth&&auth.currentUser; if(!u||!currentDocToShare) return; var tok2=await u.getIdToken(); confirmShareButton.disabled=true; confirmShareButton.textContent='Sharing…';
            try{
                var res=await fetch('/api/documents/'+currentDocToShare.id+'/share',{ method:'POST', headers:{ 'Authorization':'Bearer '+tok2,'Content-Type':'application/json' }, body:JSON.stringify({ email: shareEmailInput.value }) });
                var txt=await res.text(); var body=null; try{ body=txt?JSON.parse(txt):null; }catch(_){}
                if(!res.ok) throw new Error((body&&body.message)||res.statusText||'Failed to share');
                toast((body&&body.message)||'Document shared.', true); closeShare(); fetchDocuments();
            }catch(err){ console.error(err); toast(err.message, false); }
            finally{ confirmShareButton.disabled=false; confirmShareButton.textContent='Share'; }
            return;
        }

        // Delete modal triggers
        if(t.id==='cancel-delete-button'||t.id==='close-delete-x'||t===deleteModal){ closeDelete(); return; }
        if(t.id==='confirm-delete-button'){ var u2=auth&&auth.currentUser; if(!u2||!currentDocToDelete) return; var tok3=await u2.getIdToken(); confirmDeleteButton.disabled=true; confirmDeleteButton.textContent='Deleting…';
            try{
                var r=await fetch('/api/documents/'+currentDocToDelete.id,{ method:'DELETE', headers:{ 'Authorization':'Bearer '+tok3 }});
                if(!r.ok){ var m=await r.text(); throw new Error(m||'Failed to delete'); }
                toast('Document deleted.', true); closeDelete(); fetchDocuments();
            }catch(err){ console.error(err); toast(err.message,false); }
            finally{ confirmDeleteButton.disabled=false; confirmDeleteButton.textContent='Delete'; }
            return;
        }

        // Row actions via delegation
        if(t.closest('.btn') && t.textContent==='Download'){ var id=t.closest('.btn').dataset.docId; try{ await downloadDocument(id); }catch(err){ console.error(err); toast('Download failed.',false);} return; }
        if(t.closest('.btn') && t.textContent==='Share'){ var b=t.closest('.btn'); openShare(b.dataset.docName, b.dataset.docId); return; }
        if(t.closest('.btn') && t.textContent==='Delete'){ var b2=t.closest('.btn'); openDelete(b2.dataset.docName, b2.dataset.docId); return; }

        // Toolbar
        if(t.id==='refresh-button'){ fetchDocuments(); return; }
    });

    // ESC closes modals
    document.addEventListener('keydown', function(e){
        if(e.key==='Escape'){ closeUpload(); closeShare(); closeDelete(); }
    });
</script>
</body>
</html>
